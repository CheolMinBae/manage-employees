name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        cat >>~/.ssh/config <<END
        Host ec2
          HostName ${{ secrets.EC2_HOST }}
          User ubuntu
          IdentityFile ~/.ssh/deploy_key
          StrictHostKeyChecking no
        END
    
    - name: Copy files to EC2
      run: |
        scp -r ./* ec2:/home/ubuntu/manage-employees/
    
    - name: Deploy to EC2
      run: |
        ssh ec2 "cd /home/ubuntu/manage-employees && \
          sudo chown -R ubuntu:ubuntu . && \
          sudo chmod -R 755 . && \
          sudo usermod -aG docker ubuntu && \
          sudo systemctl restart docker && \
          sudo docker-compose down && \
          sudo docker-compose up --build -d && \
          sudo docker system prune -f" 